name: CI + Storybook Pages + Publish npm

on:
  push:
    branches: [master]

# Permissão mínima global; cada job eleva só o que precisa
permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Node 24
        uses: actions/setup-node@v4
        with:
          node-version: 24
      - name: Corepack
        run: |
          corepack enable
          corepack prepare yarn@4.12.0 --activate
      - name: Install
        run: yarn install --immutable --frozen-lockfile
      - name: Test/Lint
        run: |
          yarn test
          yarn lint
      - name: Build lib (Vite)
        run: yarn build
      - name: Validate build output
        run: |
          if [ ! -d "dist" ] || [ -z "$(ls -A dist)" ]; then
            echo "Error: dist/ folder is empty or missing"
            exit 1
          fi
          echo "Build output validated:"
          ls -la dist/
      - name: Build Storybook
        run: yarn build-storybook --quiet --output-dir storybook-static --disable-telemetry

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload Storybook artifact (Pages)
        uses: actions/upload-pages-artifact@v4
        with:
          path: storybook-static

      - name: Upload dist artifact (npm)
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 1

  deploy-pages:
    runs-on: ubuntu-latest
    needs: build

    # Concorrência só pro deploy (último deploy vence)
    concurrency:
      group: pages
      cancel-in-progress: true

    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  publish-npm:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v4

      - name: Node 24 + registry npmjs
        uses: actions/setup-node@v5
        with:
          node-version: 24
          registry-url: "https://registry.npmjs.org"

      - name: Download dist artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Validate dist artifact
        run: |
          echo "Downloaded dist contents:"
          ls -la dist/

      - name: Decide se deve publicar (versão ainda não existe no npm)
        id: ver
        shell: bash
        run: |
          PKG_NAME="$(node -p "require('./package.json').name")"
          PKG_VERSION="$(node -p "require('./package.json').version")"
          PUBLISHED_VERSION="$(npm view "$PKG_NAME" version 2>/dev/null || true)"

          echo "name=$PKG_NAME" >> "$GITHUB_OUTPUT"
          echo "version=$PKG_VERSION" >> "$GITHUB_OUTPUT"

          if [ "$PUBLISHED_VERSION" = "$PKG_VERSION" ]; then
            echo "should_publish=false" >> "$GITHUB_OUTPUT"
            echo "Já publicado no npm: $PKG_NAME@$PKG_VERSION"
          else
            echo "should_publish=true" >> "$GITHUB_OUTPUT"
            echo "Vai publicar: $PKG_NAME@$PKG_VERSION (npm atual: ${PUBLISHED_VERSION:-none})"
          fi

      - name: Publish (npm)
        if: steps.ver.outputs.should_publish == 'true'
        shell: bash
        run: |
          PKG_NAME="${{ steps.ver.outputs.name }}"
          ARGS=""

          # Se for scope e público, precisa access public (ou defina publishConfig.access)
          if [[ "$PKG_NAME" == @* ]]; then
            ARGS="--access public"
          fi

          npm publish $ARGS
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
