name: CI + Storybook Pages + Publish npm

on:
  push:
    branches: [master]

# Permissão mínima global; cada job eleva só o que precisa
permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Extract version
        id: version
        run: |
          echo 'version=$(node -p "require(\'./package.json\').version")' >> "$GITHUB_OUTPUT"
          echo 'name=$(node -p "require(\'./package.json\').name")' >> "$GITHUB_OUTPUT"
      - name: Node 24
        uses: actions/setup-node@v4
        with:
          node-version: 24
      - name: Corepack
        run: |
          corepack enable
          corepack prepare yarn@4.12.0 --activate
      - name: Install
        run: yarn install --immutable --frozen-lockfile
      - name: Test/Lint
        run: |
          yarn test
          yarn lint
      - name: Build lib (Vite)
        run: yarn build
      - name: Validate build output
        run: |
          if [ ! -d "dist" ] || [ -z "$(ls -A dist)" ]; then
            echo "Error: dist/ folder is empty or missing"
            exit 1
          fi
          echo "Build output validated:"
          ls -la dist/
      - name: Build Storybook
        run: yarn build-storybook --quiet --output-dir storybook-static --disable-telemetry

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload Storybook artifact (Pages)
        uses: actions/upload-pages-artifact@v4
        with:
          path: storybook-static

      - name: Upload dist artifact (npm)
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 1

  deploy-pages:
    runs-on: ubuntu-latest
    needs: build

    concurrency:
      group: pages
      cancel-in-progress: true

    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  publish-npm:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download dist artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/
      - name: Validate dist artifact
        run: |
          echo "Downloaded dist contents:"
          ls -la dist/
      - name: Publish (npm)
        shell: bash
        run: |
          PKG_NAME="${{ steps.version.outputs.name }}"
          PKG_VERSION="${{ steps.version.outputs.version }}"
          ARGS=""

          # Se for scope e público, precisa access public (ou defina publishConfig.access)
          if [[ "$PKG_NAME" == @* ]]; then
            ARGS="--access public"
          fi

          npm publish $ARGS
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
